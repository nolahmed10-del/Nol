<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connect Wallet — Polygon (Purple Theme)</title>

  <!-- Ethers.js (v5 UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnect v1 provider (UMD) - used as an option; switch to WalletConnect v2 if you prefer -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      --purple-900: #2b0b45;
      --purple-700: #5a0fa8;
      --purple-500: #7b2bff;
      --purple-300: #b595ff;
      --bg: #0f0813;
      --chip-bg: linear-gradient(135deg, rgba(123,43,255,0.12), rgba(90,15,168,0.06));
      --glass: rgba(255,255,255,0.04);
    }

    /* Reset / Blank canvas */
    html,body{
      height:100%;
      margin:0;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #0b0710 0%, #12061a 60%);
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Container is intentionally minimal (blank page except centered content) */
    .container{
      width:100%;
      max-width:860px;
      padding:48px;
      box-sizing:border-box;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    /* Main Connect / Disconnect button */
    .connect-btn{
      background: linear-gradient(90deg,var(--purple-700),var(--purple-500));
      border: none;
      color: white;
      padding:14px 22px;
      border-radius:12px;
      box-shadow: 0 8px 30px rgba(123,43,255,0.16), inset 0 -2px 0 rgba(0,0,0,0.15);
      font-weight:600;
      font-size:16px;
      cursor:pointer;
      display:flex;
      gap:12px;
      align-items:center;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .connect-btn:hover{ transform:translateY(-3px); box-shadow:0 18px 50px rgba(123,43,255,0.12); }

    .connect-btn .dot {
      width:10px;height:10px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff9, rgba(255,255,255,0.06) 30%), #fff;
      box-shadow: 0 2px 8px rgba(123,43,255,0.28);
    }

    /* Chip container (modal-like) - modern stylized */
    .chip-modal {
      position: fixed;
      left: 0; right: 0; bottom: 0; top: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(11,7,16,0.6), rgba(11,7,16,0.8));
      z-index: 9999;
      backdrop-filter: blur(8px) saturate(120%);
      padding: 24px;
      box-sizing: border-box;
    }

    .chip-sheet {
      width:100%;
      max-width:560px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:16px;
      padding:20px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.04);
      box-sizing:border-box;
    }

    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin-bottom:16px;
    }
    .sheet-title{
      font-size:18px;
      font-weight:700;
      color: var(--purple-300);
      display:flex;align-items:center;gap:12px;
    }
    .sheet-sub{ font-size:13px; color: #cfc7ee; opacity:0.9; }

    .wallet-list{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:6px;
    }

    /* Individual wallet chip */
    .wallet-chip{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-radius:12px;
      background: var(--chip-bg);
      border:1px solid rgba(123,43,255,0.08);
      cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease, background .12s ease;
    }
    .wallet-chip:hover{
      transform:translateY(-4px);
      box-shadow: 0 14px 40px rgba(90,15,168,0.12);
      background: linear-gradient(90deg, rgba(123,43,255,0.08), rgba(90,15,168,0.04));
    }

    .wallet-left{ display:flex; align-items:center; gap:12px; }
    .wallet-icon{
      width:44px;height:44px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background: linear-gradient(135deg, rgba(123,43,255,0.22), rgba(90,15,168,0.12));
      border:1px solid rgba(255,255,255,0.03);
      font-weight:700;
      color: white;
      font-size:16px;
      flex: 0 0 44px;
    }
    .wallet-meta{ display:flex; flex-direction:column; }
    .wallet-name{ font-weight:700; color:#fff; font-size:15px; }
    .wallet-desc{ font-size:12px; color:#d7cfff; opacity:0.95; margin-top:4px; }

    .wallet-action{ display:flex;align-items:center; gap:10px; }

    /* Connected chip (shows address + balance) */
    .connected-chip{
      display:flex;
      align-items:center;
      gap:12px;
      padding:10px 14px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(123,43,255,0.14), rgba(90,15,168,0.06));
      border:1px solid rgba(123,43,255,0.14);
      color: #fff;
      font-weight:600;
      cursor:pointer;
      box-shadow: 0 8px 30px rgba(123,43,255,0.06);
    }
    .connected-chip img{width:22px;height:22px;border-radius:6px}

    .address {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
      font-size:13px;
      color:#fff;
      opacity:0.95;
    }

    .balance{
      font-size:13px;
      color:#ffd6ff;
      opacity:0.95;
      background: rgba(255,255,255,0.02);
      padding:6px 8px;border-radius:8px;
      font-weight:700;
    }

    .close-x{
      width:36px;height:36px;border-radius:10px;
      display:inline-flex;align-items:center;justify-content:center;
      background: rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.02);
      cursor:pointer;
    }

    /* Mobile */
    @media (max-width:520px){
      .chip-sheet{ padding:14px; border-radius:12px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <button id="main-button" class="connect-btn" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span id="main-btn-text">Connect Wallet</span>
    </button>
  </div>

  <!-- Chip modal -->
  <div id="chip-modal" class="chip-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="chip-sheet" role="document" aria-label="Connect wallet">
      <div class="sheet-header">
        <div>
          <div class="sheet-title">Connect wallet</div>
          <div class="sheet-sub">Choose a wallet to connect to Polygon (Mainnet)</div>
        </div>
        <div class="close-x" id="close-modal" title="Close">
          ✕
        </div>
      </div>

      <div class="wallet-list">
        <div class="wallet-chip" id="metamask-chip" title="MetaMask (injected)">
          <div class="wallet-left">
            <div class="wallet-icon">MM</div>
            <div class="wallet-meta">
              <div class="wallet-name">MetaMask</div>
              <div class="wallet-desc">Connect with your browser's injected wallet.</div>
            </div>
          </div>
          <div class="wallet-action">
            <div style="font-size:13px;color:#dcd0ff">Injected</div>
          </div>
        </div>

        <div class="wallet-chip" id="walletconnect-chip" title="WalletConnect">
          <div class="wallet-left">
            <div class="wallet-icon">WC</div>
            <div class="wallet-meta">
              <div class="wallet-name">WalletConnect</div>
              <div class="wallet-desc">Scan QR or open a compatible mobile wallet.</div>
            </div>
          </div>
          <div class="wallet-action">
            <div style="font-size:13px;color:#dcd0ff">Protocol</div>
          </div>
        </div>

        <div class="wallet-chip" id="binance-chip" title="Binance Chain Wallet">
          <div class="wallet-left">
            <div class="wallet-icon">BN</div>
            <div class="wallet-meta">
              <div class="wallet-name">Binance Wallet</div>
              <div class="wallet-desc">Open the Binance Chain Wallet extension (if installed).</div>
            </div>
          </div>
          <div class="wallet-action">
            <div style="font-size:13px;color:#dcd0ff">Injected</div>
          </div>
        </div>
      </div>

      <!-- placeholder area for errors / status shown inside modal -->
      <div id="modal-status" style="margin-top:14px;color:#f6e9ff;font-size:13px;display:none"></div>
    </div>
  </div>

  <script>
    /***********************************************************************
     * IMPORTANT: Replace the placeholders below with your project's values.
     *
     * - POLYGON_RPC: Put your preferred Polygon RPC endpoint (e.g. from Alchemy, Infura, or QuickNode)
     *   Example: "https://polygon-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY"
     *
     * - WALLETCONNECT_PROJECT_ID: If you choose to migrate to WalletConnect v2, put your WC v2 Project ID.
     *   For the legacy WalletConnect v1 provider included here, this is NOT required, but kept as a placeholder.
     *
     ***********************************************************************/
    const POLYGON_CHAIN_ID_HEX = '0x89'; // Polygon mainnet chainId (hex)
    const POLYGON_CHAIN_ID_DEC = 137;
    const POLYGON_RPC = "https://polygon-mainnet.g.alchemy.com/v2/8ikEzpLeLerL-8xNW23fVUser"; // <-- REPLACE with your Polygon RPC (placeholder)
    const WALLETCONNECT_PROJECT_ID = '6557a92e369812727669d41cbeb95a1'; // <-- placeholder if you later use WCv2

    // Globals
    const mainButton = document.getElementById('main-button');
    const mainBtnText = document.getElementById('main-btn-text');
    const chipModal = document.getElementById('chip-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const modalStatus = document.getElementById('modal-status');

    const metamaskChip = document.getElementById('metamask-chip');
    const walletconnectChip = document.getElementById('walletconnect-chip');
    const binanceChip = document.getElementById('binance-chip');

    // Keep track of provider info
    let provider = null; // Ethers provider
    let rawProvider = null; // raw provider (window.ethereum or WalletConnect provider)
    let signer = null;
    let connectedAddress = null;
    let connectedBalance = null;
    let connectedWalletType = null; // 'injected' | 'walletconnect' | 'binance'

    // For walletconnect legacy provider constructor
    const WCProviderConstructor = window.WalletConnectProvider?.default || window.WalletConnectProvider || null;

    // Utility: shorten address
    function shorten(addr){
      if(!addr) return '';
      return addr.slice(0,6) + '…' + addr.slice(-4);
    }

    // Utility: format balance in MATIC with 4 decimals
    function formatBalance(wei){
      try{
        const eth = ethers.utils.formatEther(wei);
        const num = Number(eth);
        return (num >= 0.01) ? num.toFixed(4) : num.toString();
      }catch(e){ return '0.0000'; }
    }

    // Show modal
    function openModal(){
      chipModal.style.display = 'flex';
      chipModal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      chipModal.style.display = 'none';
      chipModal.setAttribute('aria-hidden','true');
      modalStatus.style.display = 'none';
      modalStatus.textContent = '';
    }

    // Update "main button" UI depending on connection state
    function refreshMainButton(){
      if(connectedAddress){
        mainBtnText.textContent = 'Disconnect';
        // Replace button with connected-chip look
        mainButton.classList.add('connected');
        // We will show a chip-like element inside the button showing address and balance
        mainButton.innerHTML = `
          <div class="connected-chip" id="connected-chip" title="${connectedAddress}">
            <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32'><rect width='32' height='32' rx='6' fill='%23' /></svg>" alt="">
            <div class="address">${shorten(connectedAddress)}</div>
            <div class="balance">${connectedBalance} MATIC</div>
          </div>
        `;
        // attach disconnect on click
        document.getElementById('connected-chip').addEventListener('click', disconnect);
      } else {
        // reset to original button
        mainButton.innerHTML = `<span class="dot" aria-hidden="true"></span><span id="main-btn-text">Connect Wallet</span>`;
        mainButton.classList.remove('connected');
      }
    }

    // Copy to clipboard helper
    function copyToClipboard(text){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).catch(()=>{/* ignore */});
      } else {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand('copy'); ta.remove();
      }
    }

    // Connect using injected provider (MetaMask or Binance)
    async function connectInjected(kind){
      try{
        if(!window.ethereum){
          modalStatus.style.display = 'block';
          modalStatus.textContent = `No injected wallet detected in this browser. Please install MetaMask or Binance Chain Wallet.`;
          return;
        }

        rawProvider = window.ethereum;
        // Request accounts and ensure chain is Polygon
        await ensurePolygonChain(rawProvider);
        // Request accounts
        const accounts = await rawProvider.request({ method: 'eth_requestAccounts' });
        if(!accounts || accounts.length === 0){
          modalStatus.style.display = 'block';
          modalStatus.textContent = 'No accounts returned from wallet.';
          return;
        }

        const account = ethers.utils.getAddress(accounts[0]);
        provider = new ethers.providers.Web3Provider(rawProvider);
        signer = provider.getSigner();
        connectedAddress = account;

        const bal = await provider.getBalance(account);
        connectedBalance = formatBalance(bal);

        connectedWalletType = kind === 'binance' ? 'binance' : 'injected';

        // Listen for account / chain changes
        setupInjectedListeners(rawProvider);

        // UI
        closeModal();
        refreshMainButton();
      }catch(err){
        console.error('Injected connect error:', err);
        modalStatus.style.display = 'block';
        modalStatus.textContent = 'Connection failed: ' + (err.message || err.toString());
      }
    }

    // Ensure the wallet is on Polygon mainnet; if not, ask to switch or add chain
    async function ensurePolygonChain(raw){
      try{
        const current = await raw.request({ method: 'eth_chainId' });
        if(current && current.toLowerCase() === POLYGON_CHAIN_ID_HEX) return;
        // attempt switch
        await raw.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_CHAIN_ID_HEX }]
        });
      }catch(switchError){
        // If 4902, try to add chain
        const code = switchError?.code || switchError?.data?.originalError?.code;
        if(code === 4902 || (switchError && /Unrecognized chain/i.test(switchError.message || ''))){
          try{
            await raw.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: POLYGON_CHAIN_ID_HEX,
                chainName: 'Polygon Mainnet',
                nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                rpcUrls: [POLYGON_RPC],
                blockExplorerUrls: ['https://polygonscan.com']
              }]
            });
            // after adding, try switching again
            await raw.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_ID_HEX }] });
          }catch(addErr){
            console.warn('Failed to add Polygon chain:', addErr);
            throw addErr;
          }
        } else {
          // other error
          throw switchError;
        }
      }
    }

    function setupInjectedListeners(raw){
      if(!raw || !raw.on) return;
      raw.on('accountsChanged', (accounts) => {
        if(!accounts || accounts.length === 0){
          // disconnected
          disconnect();
          return;
        }
        connectedAddress = ethers.utils.getAddress(accounts[0]);
        // refresh balance
        provider.getBalance(connectedAddress).then(b => {
          connectedBalance = formatBalance(b);
          refreshMainButton();
        }).catch(()=>refreshMainButton());
      });

      raw.on('chainChanged', (chainId) => {
        if(chainId !== POLYGON_CHAIN_ID_HEX){
          // prompt switch or disconnect
          modalStatus.style.display = 'block';
          modalStatus.textContent = 'Please switch back to Polygon network in your wallet.';
        } else {
          modalStatus.style.display = 'none';
          modalStatus.textContent = '';
        }
      });

      raw.on('disconnect', () => {
        disconnect();
      });
    }

    // Connect using WalletConnect (legacy provider included)
    async function connectWalletConnect(){
      if(!WCProviderConstructor){
        modalStatus.style.display = 'block';
        modalStatus.textContent = 'WalletConnect provider library not loaded.';
        return;
      }

      modalStatus.style.display = 'block';
      modalStatus.textContent = 'Opening WalletConnect QR...';

      try{
        // NOTE: This uses legacy WalletConnect v1 provider for simplicity.
        rawProvider = new WCProviderConstructor({
          rpc: { [POLYGON_CHAIN_ID_DEC]: POLYGON_RPC }, // replace placeholder above as needed
          chainId: POLYGON_CHAIN_ID_DEC,
          qrcode: true,
          // infuraId or projectId would be placed here for some providers; kept as placeholders.
        });

        await rawProvider.enable(); // opens QR / deep link

        provider = new ethers.providers.Web3Provider(rawProvider);
        signer = provider.getSigner();
        const accounts = await provider.listAccounts();
        if(!accounts || accounts.length === 0){
          modalStatus.textContent = 'No accounts returned from WalletConnect.';
          return;
        }

        connectedAddress = ethers.utils.getAddress(accounts[0]);
        const bal = await provider.getBalance(connectedAddress);
        connectedBalance = formatBalance(bal);
        connectedWalletType = 'walletconnect';

        // Listen for disconnect event from WC provider
        rawProvider.on && rawProvider.on('disconnect', () => {
          disconnect();
        });

        closeModal();
        refreshMainButton();
      }catch(err){
        console.error('WalletConnect error', err);
        modalStatus.style.display = 'block';
        modalStatus.textContent = 'WalletConnect failed: ' + (err && err.message ? err.message : err);
      }
    }

    async function disconnect(){
      try{
        // For WalletConnect provider, call disconnect
        if(rawProvider && rawProvider.disconnect && typeof rawProvider.disconnect === 'function'){
          try{ await rawProvider.disconnect(); } catch(e){ /* ignore */ }
        }
        // Clear our locals
        provider = null;
        rawProvider = null;
        signer = null;
        connectedAddress = null;
        connectedBalance = null;
        connectedWalletType = null;

        // restore main button
        refreshMainButton();
      }catch(err){
        console.error('Disconnect error', err);
      }
    }

    // Button click: open modal if not connected, otherwise disconnect
    mainButton.addEventListener('click', (e) => {
      if(connectedAddress){
        // clicking when connected acts as disconnect
        disconnect();
        return;
      }
      openModal();
    });

    // Modal actions
    closeModalBtn.addEventListener('click', closeModal);
    chipModal.addEventListener('click', (e) => {
      if(e.target === chipModal) closeModal();
    });

    metamaskChip.addEventListener('click', async () => {
      modalStatus.style.display = 'block';
      modalStatus.textContent = 'Connecting to MetaMask...';
      await connectInjected('metamask');
    });

    binanceChip.addEventListener('click', async () => {
      modalStatus.style.display = 'block';
      modalStatus.textContent = 'Connecting to Binance Chain Wallet...';
      await connectInjected('binance');
    });

    walletconnectChip.addEventListener('click', async () => {
      await connectWalletConnect();
    });

    // Accessibility: keyboard close with Escape
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape') closeModal();
    });

    // Initialize UI
    refreshMainButton();

    // Optional: attempt to auto-reconnect to WalletConnect session if present
    (function tryAutoReconnect(){
      try{
        // WC v1 sets wc: {connected:true} in localStorage under "walletconnect"
        const wc = localStorage.getItem('walletconnect');
        if(wc){
          // If there's a previous session we can try to reconnect silently
          // but to keep behavior transparent, do not auto-reconnect without user action.
          // You may uncomment below to auto-open modal to reconnect.
          // openModal();
        }
      }catch(e){}
    })();
  </script>
</body>
</html>
