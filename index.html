<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Connect Wallet — Polygon (Purple Theme) — WalletConnect v2 Only</title>

  <!-- Ethers.js (v5 UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <!-- WalletConnect v2 Ethereum Provider (UMD build) -->
  <!-- This exact CDN URL is known to publish the UMD bundle for @walletconnect/ethereum-provider.
       If your environment blocks this CDN, download the package and bundle it locally. -->
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/ethereum-provider@2.6.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      --purple-900: #25042f;
      --purple-700: #5a0fa8;
      --purple-500: #7b2bff;
      --purple-300: #b595ff;
      --bg: #0f0813;
    }
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#0b0710 0%, #12061a 60%);color:#fff;display:flex;align-items:center;justify-content:center;}
    .container{width:100%;max-width:860px;padding:48px;box-sizing:border-box;display:flex;align-items:center;justify-content:center;}
    .connect-btn{background:linear-gradient(90deg,var(--purple-700),var(--purple-500));border:none;color:white;padding:14px 22px;border-radius:12px;box-shadow:0 8px 30px rgba(123,43,255,0.16), inset 0 -2px 0 rgba(0,0,0,0.15);font-weight:600;font-size:16px;cursor:pointer;display:flex;gap:12px;align-items:center;transition:transform .12s ease,box-shadow .12s ease;}
    .connect-btn:hover{transform:translateY(-3px);}
    .dot{width:10px;height:10px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff9,rgba(255,255,255,0.06) 30%),#fff;box-shadow:0 2px 8px rgba(123,43,255,0.28);}
    .chip-modal{position:fixed;left:0;right:0;top:0;bottom:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(11,7,16,0.6),rgba(11,7,16,0.8));z-index:9999;backdrop-filter:blur(8px) saturate(120%);padding:24px;box-sizing:border-box;}
    .chip-sheet{width:100%;max-width:640px;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border-radius:16px;padding:20px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.04);box-sizing:border-box;}
    .sheet-header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:16px;}
    .sheet-title{font-size:18px;font-weight:700;color:var(--purple-300);display:flex;align-items:center;gap:12px;}
    .sheet-sub{font-size:13px;color:#cfc7ee;opacity:0.95;}
    .wallet-list{display:flex;flex-direction:column;gap:12px;margin-top:6px;}
    .wallet-chip{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-radius:12px;background:linear-gradient(135deg, rgba(123,43,255,0.08), rgba(90,15,168,0.02));border:1px solid rgba(123,43,255,0.06);cursor:pointer;transition:transform .12s ease,box-shadow .12s ease;}
    .wallet-chip:hover{transform:translateY(-4px);box-shadow:0 14px 40px rgba(90,15,168,0.12);}
    .wallet-left{display:flex;align-items:center;gap:12px;}
    .wallet-icon{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(123,43,255,0.22), rgba(90,15,168,0.12));border:1px solid rgba(255,255,255,0.03);font-weight:700;color:white;font-size:16px;flex:0 0 44px;}
    .wallet-meta{display:flex;flex-direction:column;}
    .wallet-name{font-weight:700;color:#fff;font-size:15px;}
    .wallet-desc{font-size:12px;color:#d7cfff;opacity:0.95;margin-top:4px;}
    .wallet-action{display:flex;align-items:center;gap:10px;}
    .connected-chip{display:flex;align-items:center;gap:12px;padding:10px 14px;border-radius:999px;background:linear-gradient(90deg,rgba(123,43,255,0.14),rgba(90,15,168,0.06));border:1px solid rgba(123,43,255,0.14);color:#fff;font-weight:600;cursor:pointer;box-shadow:0 8px 30px rgba(123,43,255,0.06);}
    .address{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,"Roboto Mono",monospace;font-size:13px;color:#fff;opacity:0.95;}
    .balance{font-size:13px;color:#ffd6ff;opacity:0.95;background:rgba(255,255,255,0.02);padding:6px 8px;border-radius:8px;font-weight:700;}
    .close-x{width:36px;height:36px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer;}
    .status{margin-top:14px;color:#f6e9ff;font-size:13px;display:none;}
  </style>
</head>
<body>
  <div class="container">
    <button id="main-button" class="connect-btn" aria-live="polite">
      <span class="dot" aria-hidden="true"></span>
      <span id="main-btn-text">Connect Wallet</span>
    </button>
  </div>

  <div id="chip-modal" class="chip-modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="chip-sheet" role="document" aria-label="Connect wallet">
      <div class="sheet-header">
        <div>
          <div class="sheet-title">Connect wallet</div>
          <div class="sheet-sub">Choose a wallet to connect to Polygon (Mainnet). WalletConnect v2 is used for best mobile support.</div>
        </div>
        <div class="close-x" id="close-modal" title="Close">✕</div>
      </div>

      <div class="wallet-list">
        <div class="wallet-chip" id="injected-chip" title="Injected wallets (MetaMask, Binance)">
          <div class="wallet-left">
            <div class="wallet-icon">MM</div>
            <div class="wallet-meta">
              <div class="wallet-name">Injected Wallet</div>
              <div class="wallet-desc">MetaMask, Binance Wallet, etc. (browser extension / app)</div>
            </div>
          </div>
          <div class="wallet-action"><div style="font-size:13px;color:#dcd0ff">Injected</div></div>
        </div>

        <div class="wallet-chip" id="walletconnect-chip" title="WalletConnect v2 (recommended)">
          <div class="wallet-left">
            <div class="wallet-icon">WC</div>
            <div class="wallet-meta">
              <div class="wallet-name">WalletConnect</div>
              <div class="wallet-desc">Open QR or deep link many mobile wallets (v2).</div>
            </div>
          </div>
          <div class="wallet-action"><div style="font-size:13px;color:#dcd0ff">QR / Deep Link</div></div>
        </div>
      </div>

      <div id="modal-status" class="status" role="status" aria-live="polite"></div>
    </div>
  </div>

  <script>
    /************************************************************************
     * IMPORTANT — CONFIGURATION
     *
     * Replace the placeholders below with your actual production values:
     * - POLYGON_RPC: a reliable Polygon RPC (Alchemy/QuickNode/Infura or your node)
     *   Example: "https://polygon-mainnet.g.alchemy.com/v2/YOUR_ALCHEMY_KEY"
     *
     * - WALLETCONNECT_PROJECT_ID: WalletConnect v2 Project ID from cloud.walletconnect.com
     *
     **************************************************************************/
    const POLYGON_CHAIN_ID_HEX = '0x89';
    const POLYGON_CHAIN_ID_DEC = 137;
       const POLYGON_RPC = "https://polygon-mainnet.g.alchemy.com/v2/8ikEzpLeLerL-8xNW23fVUser"; // <-- REPLACE with your Polygon RPC (placeholder)
    const WALLETCONNECT_PROJECT_ID = '6557a92e369812727669d41cbeb95a1'; // <-- placeholder if you later use WCv2

    // UI elements
    const mainButton = document.getElementById('main-button');
    const mainBtnText = document.getElementById('main-btn-text');
    const chipModal = document.getElementById('chip-modal');
    const closeModalBtn = document.getElementById('close-modal');
    const statusEl = document.getElementById('modal-status');

    const injectedChip = document.getElementById('injected-chip');
    const walletconnectChip = document.getElementById('walletconnect-chip');

    // State
    let provider = null;       // ethers provider
    let rawProvider = null;    // underlying provider (window.ethereum or WC provider)
    let signer = null;
    let connectedAddress = null;
    let connectedBalance = null;
    let connectedWalletType = null;

    // Utilities
    function shorten(addr){ if(!addr) return ''; return addr.slice(0,6) + '…' + addr.slice(-4); }
    function formatBalance(wei){ try{ const eth = ethers.utils.formatEther(wei); const num = Number(eth); return (num >= 0.01) ? num.toFixed(4) : Number(eth).toString(); }catch(e){ return '0.0000'; } }

    function openModal(){ chipModal.style.display = 'flex'; chipModal.setAttribute('aria-hidden','false'); }
    function closeModal(){ chipModal.style.display = 'none'; chipModal.setAttribute('aria-hidden','true'); hideStatus(); }

    function showStatus(msg){ statusEl.style.display = 'block'; statusEl.textContent = msg; }
    function hideStatus(){ statusEl.style.display = 'none'; statusEl.textContent = ''; }

    function refreshMainButton(){
      if(connectedAddress){
        mainButton.innerHTML = `
          <div class="connected-chip" id="connected-chip" title="${connectedAddress}">
            <div class="address">${shorten(connectedAddress)}</div>
            <div class="balance">${connectedBalance} MATIC</div>
          </div>
        `;
        document.getElementById('connected-chip').addEventListener('click', disconnect);
      } else {
        mainButton.innerHTML = `<span class="dot" aria-hidden="true"></span><span id="main-btn-text">Connect Wallet</span>`;
      }
    }

    // Ensure chain is Polygon, try switch or add
    async function ensurePolygonChain(raw){
      try{
        const current = await raw.request({ method: 'eth_chainId' });
        if(current && current.toLowerCase() === POLYGON_CHAIN_ID_HEX) return;
        await raw.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_ID_HEX }] });
      }catch(switchError){
        const code = switchError?.code;
        if(code === 4902 || (switchError && /Unrecognized chain/i.test(switchError.message || ''))){
          try{
            await raw.request({
              method: 'wallet_addEthereumChain',
              params: [{
                chainId: POLYGON_CHAIN_ID_HEX,
                chainName: 'Polygon Mainnet',
                nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                rpcUrls: [POLYGON_RPC],
                blockExplorerUrls: ['https://polygonscan.com']
              }]
            });
            await raw.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_ID_HEX }] });
          }catch(addErr){
            console.warn('Failed to add Polygon chain:', addErr);
            throw addErr;
          }
        } else {
          throw switchError;
        }
      }
    }

    // Setup listeners for injected providers
    function setupInjectedListeners(raw){
      if(!raw || !raw.on) return;
      raw.on('accountsChanged', (accounts) => {
        if(!accounts || accounts.length === 0){ disconnect(); return; }
        connectedAddress = ethers.utils.getAddress(accounts[0]);
        provider.getBalance(connectedAddress).then(b => { connectedBalance = formatBalance(b); refreshMainButton(); }).catch(()=>refreshMainButton());
      });
      raw.on('chainChanged', (chainId) => {
        if(chainId !== POLYGON_CHAIN_ID_HEX){
          showStatus('Please switch back to Polygon network in your wallet.');
        } else { hideStatus(); }
      });
      raw.on('disconnect', () => { disconnect(); });
    }

    // Connect injected wallet (MetaMask/Binance Mobile extension)
    async function connectInjected(){
      try{
        if(!window.ethereum){
          showStatus('No injected wallet detected. Try MetaMask mobile or install an extension.');
          return;
        }
        rawProvider = window.ethereum;
        await ensurePolygonChain(rawProvider);
        const accounts = await rawProvider.request({ method: 'eth_requestAccounts' });
        if(!accounts || accounts.length === 0){ showStatus('No accounts returned.'); return; }
        const account = ethers.utils.getAddress(accounts[0]);
        provider = new ethers.providers.Web3Provider(rawProvider);
        signer = provider.getSigner();
        connectedAddress = account;
        const bal = await provider.getBalance(account);
        connectedBalance = formatBalance(bal);
        connectedWalletType = 'injected';
        setupInjectedListeners(rawProvider);
        closeModal();
        refreshMainButton();
      }catch(err){
        console.error('Injected connect error:', err);
        showStatus('Connection failed: ' + (err?.message || err?.toString()));
      }
    }

    // WalletConnect v2 — robust initialization and detection
    async function connectWalletConnectV2(){
      // Try to find the exposed UMD symbol for the walletconnect provider
      // Different builds expose slightly different globals; check several fallbacks.
      const maybeWC = window.WalletConnect?.EthereumProvider
                    || window.WalletConnectEthereumProvider
                    || window.WalletConnectProvider
                    || window.EthereumProvider
                    || (window.WalletConnect && window.WalletConnect.default)
                    || (window.WalletConnectProvider && window.WalletConnectProvider.default)
                    || null;

      if(!maybeWC || typeof maybeWC.init !== 'function'){
        showStatus('WalletConnect v2 library not loaded or UMD global name unexpected. Make sure the script tag for @walletconnect/ethereum-provider is present.');
        console.error('WalletConnect UMD not found on window. Available globals:', Object.keys(window).filter(k => /walletconnect|WalletConnect|EthereumProvider|WalletConnectProvider/i.test(k)));
        return;
      }

      if(!WALLETCONNECT_PROJECT_ID || WALLETCONNECT_PROJECT_ID === 'YOUR_WALLETCONNECT_PROJECT_ID'){
        showStatus('Please set a valid WalletConnect v2 Project ID in the WALLETCONNECT_PROJECT_ID variable.');
        return;
      }

      showStatus('Opening WalletConnect v2 modal...');

      try{
        // Initialize the provider using the UMD's init function
        // This returns a provider instance that implements the EIP-1193 methods
        rawProvider = await maybeWC.init({
          projectId: WALLETCONNECT_PROJECT_ID,
          chains: [POLYGON_CHAIN_ID_DEC],
          showQrModal: true,
          rpcMap: { [POLYGON_CHAIN_ID_DEC]: POLYGON_RPC },
          metadata: {
            name: 'Your Project Name',
            description: 'Connect to Polygon via WalletConnect v2',
            url: window.location.origin,
            icons: []
          }
        });

        // After init(), we should request accounts
        // Some versions require enable() or request; request('eth_requestAccounts') is safest
        await rawProvider.request({ method: 'eth_requestAccounts' });

        provider = new ethers.providers.Web3Provider(rawProvider);
        signer = provider.getSigner();
        const accounts = await provider.listAccounts();
        if(!accounts || accounts.length === 0){
          showStatus('No accounts returned from WalletConnect.');
          return;
        }

        connectedAddress = ethers.utils.getAddress(accounts[0]);
        const bal = await provider.getBalance(connectedAddress);
        connectedBalance = formatBalance(bal);
        connectedWalletType = 'walletconnect_v2';

        // wire events
        if(rawProvider.on){
          rawProvider.on('disconnect', () => { disconnect(); });
          rawProvider.on('accountsChanged', (accounts) => {
            if(!accounts || accounts.length === 0){ disconnect(); return; }
            connectedAddress = ethers.utils.getAddress(accounts[0]);
            provider.getBalance(connectedAddress).then(b => { connectedBalance = formatBalance(b); refreshMainButton(); }).catch(()=>refreshMainButton());
          });
          rawProvider.on('chainChanged', (chainId) => {
            if(chainId !== POLYGON_CHAIN_ID_HEX){
              showStatus('Please switch back to Polygon network in your wallet.');
            } else { hideStatus(); }
          });
        }

        closeModal();
        refreshMainButton();
      }catch(err){
        console.error('WalletConnect v2 error:', err);
        showStatus('WalletConnect failed: ' + (err?.message || err?.toString()));
      }
    }

    // Cleanly disconnect and cleanup sessions (WalletConnect supports disconnect())
    async function disconnect(){
      try{
        if(rawProvider && typeof rawProvider.disconnect === 'function'){
          try{ await rawProvider.disconnect(); }catch(e){ /* ignore errors */ }
        }
      }catch(e){}
      provider = null;
      rawProvider = null;
      signer = null;
      connectedAddress = null;
      connectedBalance = null;
      connectedWalletType = null;
      refreshMainButton();
      hideStatus();
    }

    // Event wiring
    mainButton.addEventListener('click', (e) => {
      if(connectedAddress){ disconnect(); return; }
      openModal();
    });
    closeModalBtn.addEventListener('click', closeModal);
    chipModal.addEventListener('click', (e) => { if(e.target === chipModal) closeModal(); });

    injectedChip.addEventListener('click', async () => {
      showStatus('Connecting to injected wallet...');
      await connectInjected();
    });

    walletconnectChip.addEventListener('click', async () => {
      await connectWalletConnectV2();
    });

    document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });

    // Initialize
    refreshMainButton();

    // Helpful developer diagnostics (runs once)
    (function diagnostics(){
      // Log whether walletconnect script loaded and what globals exist
      const hasWC = !!(window.WalletConnect?.EthereumProvider || window.WalletConnectEthereumProvider || window.WalletConnectProvider || window.EthereumProvider);
      console.log('Diagnostics: WalletConnect v2 UMD detected:', hasWC);
      if(!hasWC){
        console.warn('WalletConnect v2 UMD not detected. If you see "library not loaded" errors, check the script tag and network access to cdn.jsdelivr.net.');
      }
    })();
  </script>
</body>
</html>
